{% extends "base.html" %}

{% block content %}
  <section class="hero-card">
    <div>
      <p class="eyebrow">Welcome back</p>
      <h1 class="hero-title">Your day, made simple</h1>
      <p class="hero-subtitle">Plan, track, and finish the day with confidence.</p>
    </div>
    <div class="hero-stats">
      <div class="stat-pill">
        <span>Plan</span>
        <strong>{{ plans_done }} / {{ plans | length }}</strong>
      </div>
      <div class="stat-pill">
        <span>Checklist</span>
        <strong>{{ checklist_done }} / {{ checklist_total }}</strong>
      </div>
      <div class="stat-pill">
        <span>Habits met</span>
        <strong>{{ habits_hit }} / {{ habit_total }}</strong>
      </div>
      <div class="stat-pill">
        <span>Routine steps</span>
        <strong>{{ routine_items_done }} / {{ routine_items_total }}</strong>
      </div>
    </div>
  </section>

  <nav class="section-nav">
    <a href="#plan-checklist" class="section-link">Plan + Checklist</a>
    <a href="#spending-habits" class="section-link">Spending + Habits</a>
    <a href="#routines-reflection" class="section-link">Routines + Reflection</a>
  </nav>

  <section id="plan-checklist" class="page-section">
    <header class="section-header">
      <div>
        <p class="section-kicker">Focus area</p>
        <h2 class="section-heading">Plan your day</h2>
      </div>
      <div class="section-controls">
        <p class="section-note">Keep your priorities and quick wins together for the next {{ reset_cycle_days }} days.</p>
        <form method="post" action="{{ url_for('update_reset_cycle') }}" class="cycle-form">
          <label class="cycle-label">Reset cycle (days)</label>
          <div class="cycle-inputs">
            <input class="form-control" name="reset_cycle_days" value="{{ reset_cycle_days }}" inputmode="numeric" pattern="[0-9]*">
            <button class="btn btn-outline-primary">Save</button>
          </div>
        </form>
      </div>
    </header>
    <div class="section-grid">
      <div class="section-card">
      <h2 class="section-title">Daily plan</h2>
      <p class="section-subtitle">Add your top priorities for today.</p>
      <form method="post" action="{{ url_for('add_plan') }}" class="stack">
        <input class="form-control form-control-lg" name="title" placeholder="Main task" required>
        <input class="form-control" name="time_block" placeholder="Time (optional)">
        <div class="form-row">
          <select class="form-select" name="priority">
            <option value="3">Priority 3</option>
            <option value="2" selected>Priority 2</option>
            <option value="1">Priority 1</option>
          </select>
          <input class="form-control" type="date" name="scheduled_date" value="{{ today_iso }}">
          <button class="btn btn-primary">Add</button>
        </div>
      </form>
      <div class="list-stack">
        {% for plan in plans %}
          <div class="list-item">
            <div>
              <div class="item-title">{{ plan["title"] }}</div>
              <div class="item-meta">
                {{ plan["scheduled_date"] }} ·
                {{ plan["time_block"] if plan["time_block"] else "Flexible time" }}
                · Priority {{ plan["priority"] }}
              </div>
            </div>
            <div class="item-actions">
              {% if plan["status"] == "pending" %}
                <span class="badge badge-warn">Open</span>
                <form method="post" action="{{ url_for('complete_plan', plan_id=plan['id']) }}">
                  <button class="btn btn-success btn-sm">Done</button>
                </form>
              {% elif plan["status"] == "done" %}
                <span class="badge badge-good">Done</span>
                <form method="post" action="{{ url_for('reopen_plan', plan_id=plan['id']) }}">
                  <button class="btn btn-outline-secondary btn-sm">Reopen</button>
                </form>
              {% else %}
                <span class="badge badge-bad">Missed</span>
                <form method="post" action="{{ url_for('reopen_plan', plan_id=plan['id']) }}">
                  <button class="btn btn-outline-secondary btn-sm">Reopen</button>
                </form>
              {% endif %}
              <form method="post" action="{{ url_for('delete_plan', plan_id=plan['id']) }}">
                <button class="btn btn-outline-danger btn-sm">Delete</button>
              </form>
            </div>
          </div>
        {% else %}
          <p class="empty-state">No plan items yet.</p>
        {% endfor %}
      </div>
    </div>

      <div class="section-card">
      <h2 class="section-title">Checklist</h2>
      <p class="section-subtitle">Small wins that keep the day steady.</p>
      <form method="post" action="{{ url_for('add_checklist_item') }}" class="stack">
        <input class="form-control form-control-lg" name="label" placeholder="Quick task" required>
        <div class="form-row">
          <input class="form-control" type="date" name="scheduled_date" value="{{ today_iso }}">
          <button class="btn btn-primary">Add</button>
        </div>
      </form>
      <div class="list-stack">
        {% for item in checklist %}
          <div class="list-item">
            <div>
              <div class="item-title {{ 'text-line' if item['done'] else '' }}">{{ item["label"] }}</div>
              <div class="item-meta">{{ item["scheduled_date"] }}</div>
            </div>
            <div class="item-actions">
              <form method="post" action="{{ url_for('toggle_checklist_item', item_id=item['id']) }}">
                <button class="btn btn-sm {{ 'btn-success' if item['done'] else 'btn-outline-secondary' }}">
                  {{ "Done" if item['done'] else "Mark done" }}
                </button>
              </form>
              <form method="post" action="{{ url_for('delete_checklist_item', item_id=item['id']) }}">
                <button class="btn btn-outline-danger btn-sm">Remove</button>
              </form>
            </div>
          </div>
        {% else %}
          <p class="empty-state">No checklist items yet.</p>
        {% endfor %}
      </div>
    </div>
    </div>
  </section>

  <section id="spending-habits" class="page-section">
    <header class="section-header">
      <div>
        <p class="section-kicker">Focus area</p>
        <h2 class="section-heading">Energy & money</h2>
      </div>
      <p class="section-note">Log today, review the week, and keep your streaks alive.</p>
    </header>
    <div class="section-grid">
      <div class="section-card">
      <h2 class="section-title">Spending</h2>
      <p class="section-subtitle">Track today and stay within your limits.</p>
      <form method="post" action="{{ url_for('add_spending') }}" class="stack">
        <div class="form-row">
          <input class="form-control" name="amount" placeholder="£12.50" required>
          <select class="form-select" name="category">
            <option>Food</option>
            <option>Transport</option>
            <option>Home</option>
            <option>Health</option>
            <option>Fun</option>
            <option>Other</option>
          </select>
        </div>
        <input class="form-control" name="note" placeholder="Note (optional)">
        <div class="form-row">
          <input class="form-control" type="date" name="spend_date" value="{{ today_iso }}">
          <button class="btn btn-primary">Log spend</button>
        </div>
      </form>
      <div class="summary-box">
        <div>
          <span>Cycle total</span>
          <strong>£{{ "%.2f"|format(spend_total) }}</strong>
        </div>
        {% if daily_spend_limit and daily_spend_limit > 0 %}
          <div>
            <span>Left today</span>
            <strong class="{{ 'text-danger' if left_to_spend is not none and left_to_spend < 0 else '' }}">
              £{{ "%.2f"|format(left_to_spend) }}
            </strong>
          </div>
        {% endif %}
      </div>

      <div class="list-stack">
        {% for entry in spending_entries %}
          <div class="list-item">
            <div>
              <div class="item-title">£{{ "%.2f"|format(entry["amount"]) }}</div>
              <div class="item-meta">{{ entry["spend_date"] }} ? {{ entry["category"] }} - {{ entry["note"] }}</div>
            </div>
            <form method="post" action="{{ url_for('delete_spending', entry_id=entry['id']) }}">
              <button class="btn btn-outline-danger btn-sm">Remove</button>
            </form>
          </div>
        {% else %}
          <p class="empty-state">No spending logged yet.</p>
        {% endfor %}
      </div>

      <div class="divider"></div>
      <h3 class="section-mini-title">Daily budget limits</h3>
      <form method="post" action="{{ url_for('update_spend_limit') }}" class="form-row">
        <input class="form-control" name="daily_spend_limit" placeholder="Daily limit for all categories" value="{{ daily_spend_limit }}">
        <button class="btn btn-outline-primary">Save limit</button>
      </form>
      <form method="post" action="{{ url_for('add_budget') }}" class="stack">
        <input class="form-control" name="category" placeholder="Category name" required>
        <div class="form-row">
          <input class="form-control" name="daily_limit" placeholder="Daily limit">
          <input class="form-control" name="weekly_limit" placeholder="Weekly limit">
          <button class="btn btn-outline-primary">Save category</button>
        </div>
      </form>
      <div class="list-stack">
        {% for budget in spending_budgets %}
          {% set spent = spend_category_map.get(budget["category"], 0) %}
          {% set week_spent = spend_week_category_map.get(budget["category"], 0) %}
          {% set over_daily = budget["daily_limit"] > 0 and spent > budget["daily_limit"] %}
          {% set over_week = budget["weekly_limit"] > 0 and week_spent > budget["weekly_limit"] %}
          {% set daily_ratio = (spent / budget["daily_limit"] * 100) if budget["daily_limit"] else 0 %}
          {% set weekly_ratio = (week_spent / budget["weekly_limit"] * 100) if budget["weekly_limit"] else 0 %}
          {% set daily_ratio_capped = daily_ratio if daily_ratio < 100 else 100 %}
          {% set weekly_ratio_capped = weekly_ratio if weekly_ratio < 100 else 100 %}
          {% if daily_ratio < 70 %}
            {% set daily_bar_class = "bar-good" %}
          {% elif daily_ratio < 90 %}
            {% set daily_bar_class = "bar-warn" %}
          {% else %}
            {% set daily_bar_class = "bar-bad" %}
          {% endif %}
          {% if weekly_ratio < 70 %}
            {% set weekly_bar_class = "bar-good" %}
          {% elif weekly_ratio < 90 %}
            {% set weekly_bar_class = "bar-warn" %}
          {% else %}
            {% set weekly_bar_class = "bar-bad" %}
          {% endif %}
          <div class="list-item">
            <div class="budget-block">
              <div class="item-title">{{ budget["category"] }}</div>
              <div class="item-meta">
                Today: £{{ "%.2f"|format(spent) }} / £{{ "%.2f"|format(budget["daily_limit"]) }}
                - Week: £{{ "%.2f"|format(week_spent) }} / £{{ "%.2f"|format(budget["weekly_limit"]) }}
              </div>
              {% if budget["daily_limit"] %}
                <div class="progress">
                  <div class="progress-bar {{ daily_bar_class }}" style="width: {{ daily_ratio_capped }}%"></div>
                </div>
              {% endif %}
              {% if budget["weekly_limit"] %}
                <div class="progress">
                  <div class="progress-bar {{ weekly_bar_class }}" style="width: {{ weekly_ratio_capped }}%"></div>
                </div>
              {% endif %}
              {% if over_daily or over_week %}
                <div class="budget-alert">Over budget today.</div>
              {% endif %}
            </div>
            <form method="post" action="{{ url_for('delete_budget', budget_id=budget['id']) }}">
              <button class="btn btn-outline-danger btn-sm">Remove</button>
            </form>
          </div>
        {% else %}
          <p class="empty-state">No budgets yet.</p>
        {% endfor %}
      </div>
    </div>

      <div class="section-card">
      <h2 class="section-title">Habits</h2>
      <p class="section-subtitle">Keep your streaks alive.</p>
      <div class="list-stack">
        {% for habit in habits %}
          {% set count = habit_log_map.get(habit["id"], 0) %}
          {% set habit_progress = (count / habit["target_count"] * 100) if habit["target_count"] else 0 %}
          {% set habit_progress_capped = habit_progress if habit_progress < 100 else 100 %}
          {% if habit_progress < 70 %}
            {% set habit_progress_class = "bar-bad" %}
          {% elif habit_progress < 90 %}
            {% set habit_progress_class = "bar-warn" %}
          {% else %}
            {% set habit_progress_class = "bar-good" %}
          {% endif %}
          <div class="list-item">
            <div class="budget-block">
              <div class="item-title">{{ habit["name"] }}</div>
              <div class="item-meta">
                Target {{ habit["target_count"] }} - Logged {{ count }} - Streak {{ habit_streaks.get(habit["id"], 0) }} days
              </div>
              <div class="progress">
                <div class="progress-bar {{ habit_progress_class }}" style="width: {{ habit_progress_capped }}%"></div>
              </div>
            </div>
            <div class="item-actions">
              <form method="post" action="{{ url_for('log_habit', habit_id=habit['id']) }}">
                <button class="btn btn-primary btn-sm">+1</button>
              </form>
              <form method="post" action="{{ url_for('reset_habit', habit_id=habit['id']) }}">
                <button class="btn btn-outline-secondary btn-sm">Reset</button>
              </form>
            </div>
          </div>
        {% else %}
          <p class="empty-state">No habits yet.</p>
        {% endfor %}
      </div>
      <form method="post" action="{{ url_for('add_habit') }}" class="form-row">
        <input class="form-control" name="name" placeholder="New habit" required>
        <input class="form-control" name="target_count" value="1">
        <button class="btn btn-outline-primary">Add habit</button>
      </form>
    </div>
    </div>
  </section>

  <section id="routines-reflection" class="page-section">
    <header class="section-header">
      <div>
        <p class="section-kicker">Focus area</p>
        <h2 class="section-heading">Routines & reflection</h2>
      </div>
      <p class="section-note">Structure your day, then close it out with a quick check-in.</p>
    </header>
    <div class="section-grid">
      <div class="section-card">
      <h2 class="section-title">Routines</h2>
      <p class="section-subtitle">Morning, afternoon, and evening steps.</p>
      <div class="list-stack">
        {% for routine in routines %}
          <div class="routine-block">
            <div class="item-title">{{ routine["name"] }}</div>
            <div class="item-meta">{{ routine["time_of_day"] }}</div>
            <div class="stack">
              {% for item in routine["items"] %}
                <div class="list-item">
                  <span class="{{ 'text-line' if item['done'] else '' }}">{{ item["label"] }}</span>
                  <form method="post" action="{{ url_for('toggle_routine_item', item_id=item['id']) }}">
                    <button class="btn btn-sm {{ 'btn-success' if item['done'] else 'btn-outline-secondary' }}">
                      {{ "Done" if item['done'] else "Mark" }}
                    </button>
                  </form>
                </div>
              {% else %}
                <p class="empty-state">No routine steps yet.</p>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <p class="empty-state">No routines yet.</p>
        {% endfor %}
      </div>
      <form method="post" action="{{ url_for('add_routine') }}" class="form-row">
        <input class="form-control" name="name" placeholder="Routine name" required>
        <select class="form-select" name="time_of_day">
          <option value="morning">Morning</option>
          <option value="afternoon">Afternoon</option>
          <option value="evening">Evening</option>
          <option value="any">Anytime</option>
        </select>
        <button class="btn btn-outline-primary">Add routine</button>
      </form>
      <form method="post" action="{{ url_for('add_routine_item') }}" class="stack">
        <select class="form-select" name="routine_id" required>
          <option value="">Select routine</option>
          {% for routine in routines %}
            <option value="{{ routine['id'] }}">{{ routine["name"] }}</option>
          {% endfor %}
        </select>
        <div class="form-row">
          <input class="form-control" name="label" placeholder="Routine step" required>
          <input class="form-control" name="sort_order" placeholder="Order" value="0">
          <button class="btn btn-outline-primary">Add step</button>
        </div>
      </form>
    </div>

      <div class="section-card">
      <h2 class="section-title">Daily reflection</h2>
      <p class="section-subtitle">Close the day with clarity.</p>
      <form method="post" action="{{ url_for('save_reflection') }}" class="stack">
        <input type="hidden" name="log_date" value="{{ today_iso }}">
        <input class="form-control" name="mood" placeholder="Mood (calm, focused, tired)" value="{{ reflection['mood'] if reflection else '' }}">
        <input class="form-control" name="wins" placeholder="Wins today" value="{{ reflection['wins'] if reflection else '' }}">
        <input class="form-control" name="blockers" placeholder="Blockers or lessons" value="{{ reflection['blockers'] if reflection else '' }}">
        <input class="form-control" name="gratitude" placeholder="Gratitude" value="{{ reflection['gratitude'] if reflection else '' }}">
        <button class="btn btn-primary">Save reflection</button>
      </form>
      <div class="list-stack">
        {% for item in reflections %}
          <div class="list-item">
            <div>
              <div class="item-title">{{ item["log_date"] }}</div>
              <div class="item-meta">Mood: {{ item["mood"] }}</div>
              {% if item["wins"] %}
                <div class="item-meta">Wins: {{ item["wins"] }}</div>
              {% endif %}
              {% if item["blockers"] %}
                <div class="item-meta">Blockers: {{ item["blockers"] }}</div>
              {% endif %}
              {% if item["gratitude"] %}
                <div class="item-meta">Gratitude: {{ item["gratitude"] }}</div>
              {% endif %}
            </div>
          </div>
        {% else %}
          <p class="empty-state">No reflections yet.</p>
        {% endfor %}
      </div>
    </div>
    </div>
  </section>
{% endblock %}
